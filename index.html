<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CS2 Audio Fix — by Zevzec</title>
  <meta name="description" content="CS2 Audio Fix: compresie + EQ pentru pași mai clari și explozii mai blânde (Equalizer APO + Peace + ReaComp). VAC safe." />

  <style>
    :root{
      --bg:#070A0F;
      --panel:#0E1420;
      --panel2:#0B1220;
      --border:rgba(255,255,255,.08);
      --text:#EAF0FF;
      --muted:#93A4C7;

      --green:#3DFF75; /* actions */
      --red:#FF3B3B;   /* warnings */
      --shadow: 0 16px 48px rgba(0,0,0,.45);
      --radius:18px;
      --max:1120px;

      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{ box-sizing:border-box }
    html{ scroll-behavior:smooth }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 12% 12%, rgba(255,59,59,.10), transparent 58%),
        radial-gradient(900px 600px at 85% 20%, rgba(61,255,117,.10), transparent 56%),
        radial-gradient(900px 700px at 55% 95%, rgba(100,140,255,.08), transparent 60%),
        var(--bg);
    }

    a{ color:inherit }
    .wrap{ max-width:var(--max); margin:0 auto; padding:28px 16px 56px; }

    /* TOP BAR */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.3px;
    }
    .brand .dot{
      width:10px;height:10px;border-radius:99px;
      background:linear-gradient(90deg,var(--red),var(--green));
      box-shadow: 0 0 18px rgba(61,255,117,.35);
    }

    /* Toggle (CLICKABLE) */
    .langToggle{
      display:flex;
      align-items:center;
      gap:0;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      padding:4px;
      box-shadow:var(--shadow);
      user-select:none;
      position:relative;
      z-index:10;
    }
    .langToggle button{
      border:0;
      background:transparent;
      color:var(--muted);
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      transition: all .15s ease;
      min-width:54px;
    }
    .langToggle button:hover{ color:var(--text) }
    .langToggle button.active{
      background:rgba(61,255,117,.15);
      color:var(--green);
      box-shadow: 0 0 0 1px rgba(61,255,117,.18) inset;
    }

    /* HERO */
    .hero{
      border:1px solid var(--border);
      border-radius: calc(var(--radius) + 6px);
      overflow:hidden;
      box-shadow:var(--shadow);
      position:relative;
      min-height: 380px;
      background:
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.88)),
        url("./header.png");
      background-size:cover;
      background-position:center;
    }
    .heroInner{
      padding:28px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      min-height: 380px;
      align-content:end;
    }
    @media (max-width: 900px){
      .heroInner{ grid-template-columns: 1fr; min-height: 340px; }
    }

    .badgeRow{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      font-weight:800;
      font-size:13px;
      backdrop-filter: blur(8px);
    }
    .badge strong{ color:var(--green) }
    .badge img{ height:18px; width:auto; display:block; opacity:.95; }

    h1{
      margin:10px 0 8px;
      font-size: clamp(28px, 3.4vw, 44px);
      line-height:1.05;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      color:rgba(234,240,255,.82);
      font-size: clamp(14px, 1.4vw, 16px);
      line-height:1.5;
      max-width: 62ch;
    }

    .ctaRow{
      margin-top:16px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      text-decoration:none;
      font-weight:900;
      letter-spacing:.2px;
      transition: all .15s ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      background:rgba(255,255,255,.06);
    }
    .btnPrimary{
      background:rgba(61,255,117,.14);
      border-color: rgba(61,255,117,.25);
      color:var(--green);
      box-shadow: 0 0 0 1px rgba(61,255,117,.12) inset;
    }
    .btnPrimary:hover{
      background:rgba(61,255,117,.18);
    }
    .btnDanger{
      background:rgba(255,59,59,.12);
      border-color: rgba(255,59,59,.22);
      color:#ffd7d7;
      box-shadow: 0 0 0 1px rgba(255,59,59,.10) inset;
    }
    .miniNote{
      margin-top:10px;
      color:rgba(234,240,255,.65);
      font-size:12.5px;
    }

    /* Layout sections */
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border-radius: var(--radius);
      padding:16px 16px;
      box-shadow:var(--shadow);
    }
    .card h3{
      margin:0 0 8px;
      font-size:16px;
      letter-spacing:.2px;
    }
    .card p{ margin:0; color:rgba(234,240,255,.78); line-height:1.5; font-size:14px; }
    .muted{ color:var(--muted) }

    .list{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:8px;
    }
    .li{
      display:flex;
      gap:10px;
      align-items:flex-start;
      color:rgba(234,240,255,.82);
      font-size:14px;
      line-height:1.45;
    }
    .tagAction{
      color:var(--green);
      font-weight:900;
    }
    .tagWarn{
      color:var(--red);
      font-weight:900;
    }

    .kbd{
      font-family:var(--mono);
      font-size:12.5px;
      padding:2px 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      color:rgba(234,240,255,.92);
      display:inline-block;
    }

    /* A/B Player */
    .abTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      font-size:12.5px;
      color:rgba(234,240,255,.85);
    }
    .led{
      width:10px;height:10px;border-radius:99px;
      background:#3a3f4a;
      box-shadow:none;
    }
    .led.on{
      background:var(--green);
      box-shadow: 0 0 16px rgba(61,255,117,.35);
    }

    .abControls{
      margin-top:10px;
      display:grid;
      gap:10px;
    }
    .abRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .abSlider{
      width:100%;
      accent-color: var(--green);
    }
    .progressWrap{
      display:grid;
      gap:6px;
    }
    .progressBar{
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      overflow:hidden;
    }
    .progressFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,59,59,.85), rgba(61,255,117,.85));
    }
    .status{
      font-size:12.5px;
      color:rgba(234,240,255,.70);
    }
    .status.error{ color:#ffb3b3; }
    .tiny{
      font-size:12.5px;
      color:rgba(234,240,255,.62);
      line-height:1.4;
    }

    /* Video */
    .video{
      margin-top:14px;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      box-shadow:var(--shadow);
    }
    .video iframe{
      width:100%;
      aspect-ratio: 16 / 9;
      border:0;
      display:block;
    }

    /* Footer */
.footerZ{
  margin-top:28px;
  text-align:center;
  color:rgba(234,240,255,.55);
  font-size:12.5px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}

.footerZ img{
  width:123px;
  height:auto;
  opacity:.9;
  filter: drop-shadow(0 6px 18px rgba(0,0,0,.6));
}

    /* Language blocks */
    [data-lang]{ display:none; }
    [data-lang].show{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>CS2 Audio Fix</span>
      </div>

      <div class="langToggle" role="tablist" aria-label="Language toggle">
        <button id="btnRO" class="active" type="button">RO</button>
        <button id="btnEN" type="button">EN</button>
      </div>
    </div>

    <!-- HERO -->
    <section class="hero" aria-label="Header">
      <div class="heroInner">
        <div>
          <div class="badgeRow">
            <span class="badge"><img src="./csgo-4.svg" alt="CS2" /> <span><strong>Optimized</strong> for CS2</span></span>
            <span class="badge"><span class="tagAction">VAC Safe</span> • Windows Audio</span>
          </div>

          <!-- RO HERO -->
          <div data-lang="ro" class="show" id="roHero">
            <h1>Auzi pașii prin rafale & explozii.</h1>
            <p class="sub">Compresie + EQ la nivel de Windows (Equalizer APO + Peace + ReaComp). Nu modifică jocul.</p>
            <div class="ctaRow">
              <a class="btn btnPrimary" href="./cs2_pasi.csv" download>Download preset CSV</a>
              <a class="btn" href="#tutorial">Tutorial complet</a>
              <a class="btn" href="#test">Test APO ON/OFF</a>
            </div>
          </div>

          <!-- EN HERO -->
          <div data-lang="en" id="enHero">
            <h1>Hear footsteps through gunfire & explosions.</h1>
            <p class="sub">Windows-level compression + EQ (Equalizer APO + Peace + ReaComp). No game modification.</p>
            <div class="ctaRow">
              <a class="btn btnPrimary" href="./cs2_pasi.csv" download>Download preset CSV</a>
              <a class="btn" href="#tutorial">Full tutorial</a>
              <a class="btn" href="#test">APO ON/OFF test</a>
            </div>
          </div>
        </div>

        <div style="display:grid; gap:14px;">
          <!-- WHAT IT DOES -->
          <div class="card">
            <h3 data-lang="ro" class="show">Ce face compresia sunetului?</h3>
            <h3 data-lang="en">What does compression do?</h3>

            <p data-lang="ro" class="show">
              Reduce diferența dintre sunetele <b>foarte tari</b> (arme/flash) și cele <b>slabe</b> (pași).
              Rezultatul: poți ține volumul mai jos și totuși auzi pașii mai clar.
            </p>
            <p data-lang="en">
              It reduces the gap between <b>very loud</b> sounds (gunshots/flash) and <b>quiet</b> sounds (footsteps).
              Result: you can keep volume lower while footsteps stay clearer.
            </p>

            <ul class="list" style="margin-top:12px">
              <li class="li"><span class="tagWarn">NU</span> rula Sonar/Voicemeeter/virtual devices în paralel.</li>
              <li class="li"><span class="tagAction">DA</span> Windows: Disable Enhancements + Exclusive Mode OFF.</li>
            </ul>
          </div>

          <!-- A/B TEST CARD (IN HEADER) -->
          <div class="card" id="test">
            <div class="abTop">
              <div>
                <h3 data-lang="ro" class="show" style="margin:0 0 4px;">A/B Test — auzi diferența</h3>
                <h3 data-lang="en" style="margin:0 0 4px;">A/B Test — hear the difference</h3>
                <div class="tiny muted" data-lang="ro" class="show">Apasă <b>Preload</b> (fișiere ~4 min), apoi Play și comută sliderul.</div>
                <div class="tiny muted" data-lang="en">Press <b>Preload</b> (files ~4 min), then Play and move the slider.</div>
              </div>

              <div class="pill" title="Status">
                <span id="led" class="led"></span>
                <span id="modeLabel">Original</span>
              </div>
            </div>

            <div class="abControls">
              <div class="abRow">
                <button id="btnPreload" class="btn btnPrimary" type="button">Preload</button>
                <button id="btnPlay" class="btn" type="button">Play</button>
                <button id="btnStop" class="btn btnDanger" type="button">Stop</button>
              </div>

              <div class="progressWrap">
                <div class="progressBar" aria-label="preload progress">
                  <div id="progressFill" class="progressFill"></div>
                </div>
                <div id="status" class="status">Ready.</div>
              </div>

              <div>
                <input id="abMix" class="abSlider" type="range" min="0" max="1" step="0.01" value="0" />
                <div class="abRow" style="justify-content:space-between;">
                  <span class="tiny"><b>Original</b> (stânga)</span>
                  <span class="tiny"><b>Compressed</b> (dreapta)</span>
                </div>
              </div>

              <!-- hidden audio elements -->


              
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTENT GRID -->
    <section class="grid" id="tutorial">
      <div class="card">
        <h3 data-lang="ro" class="show">1) Instalează Equalizer APO</h3>
        <h3 data-lang="en">1) Install Equalizer APO</h3>

        <ul class="list">
          <li class="li"><span class="tagAction">Download</span> <a href="https://sourceforge.net/projects/equalizerapo/" target="_blank" rel="noopener">sourceforge.net/projects/equalizerapo</a></li>
          <li class="li"><span class="tagAction">Run</span> installer → Run as administrator</li>
          <li class="li"><span class="tagAction">Bifează</span> DOAR device-ul fizic real (USB Headset / Realtek Speakers)</li>
          <li class="li"><span class="tagWarn">NU</span> HDMI / NVIDIA / virtual devices</li>
          <li class="li"><span class="tagAction">Restart</span> PC</li>
        </ul>
      </div>

      <div class="card">
        <h3 data-lang="ro" class="show">2) Instalează Peace</h3>
        <h3 data-lang="en">2) Install Peace</h3>

        <ul class="list">
          <li class="li"><span class="tagAction">Download</span> <a href="https://sourceforge.net/projects/peace-equalizer-apo-extension/" target="_blank" rel="noopener">sourceforge.net/projects/peace-equalizer-apo-extension</a></li>
          <li class="li"><span class="tagAction">Alege</span> Full Interface</li>
        </ul>
      </div>

      <div class="card">
        <h3 data-lang="ro" class="show">3) Instalează ReaPlugs (Reaper)</h3>
        <h3 data-lang="en">3) Install ReaPlugs (Reaper)</h3>

        <ul class="list">
          <li class="li"><span class="tagAction">Download</span> <a href="https://www.reaper.fm/reaplugs/" target="_blank" rel="noopener">reaper.fm/reaplugs</a></li>
          <li class="li"><span class="tagAction">Instalează</span> ReaPlugs VST (64-bit) cu setări default</li>
        </ul>
      </div>

      <div class="card">
        <h3 data-lang="ro" class="show">4) Creează lanțul în Peace (IMPORTANT)</h3>
        <h3 data-lang="en">4) Build the chain in Peace (IMPORTANT)</h3>

        <ul class="list">
          <li class="li"><span class="tagAction">Peace</span> → Commands → Use Editor (VST)</li>
          <li class="li"><span class="tagAction">Tab</span> Before Peace EQ</li>
          <li class="li"><span class="tagAction">Add</span> Basic Filters → Preamp (−7.00 dB)</li>
          <li class="li"><span class="tagAction">Add</span> Plugins → VST plugin → <span class="kbd">reacomp-standalone.dll</span></li>
          <li class="li"><span class="tagAction">După compresor</span> vine EQ (Graphic EQ / Peace)</li>
        </ul>
      </div>

      <div class="card">
        <h3 data-lang="ro" class="show">5) Preset EQ (CSV)</h3>
        <h3 data-lang="en">5) EQ preset (CSV)</h3>

        <ul class="list">
          <li class="li"><span class="tagAction">Download</span> preset: <a href="./cs2_pasi.csv" download>cs2_pasi.csv</a></li>
          <li class="li"><span class="tagAction">Import</span> în Peace (Import / Load preset)</li>
        </ul>

        <div style="height:10px"></div>

        <h3 style="margin-top:8px" data-lang="ro" class="show">Opțional: creează-ți propriul CSV</h3>
        <h3 style="margin-top:8px" data-lang="en">Optional: create your own CSV</h3>

        <ul class="list">
          <li class="li"><span class="tagAction">Click dreapta</span> Desktop → New → Text Document</li>
          <li class="li"><span class="tagAction">Redenumește</span> în <span class="kbd">name.csv</span> (nu .txt)</li>
          <li class="li"><span class="tagAction">Lipește</span> exact conținutul și Save</li>
          <li class="li"><span class="tagAction">Import</span> în Peace</li>
          <li class="li"><span class="tagWarn">Dacă devine</span> <span class="kbd">name.csv.txt</span>, șterge <span class="kbd">.txt</span> (View → File name extensions)</li>
        </ul>
      </div>

      <div class="card">
        <h3 data-lang="ro" class="show">6) Windows Settings</h3>
        <h3 data-lang="en">6) Windows Settings</h3>

        <ul class="list">
          <li class="li"><span class="tagAction">Sounds</span> → Playback → device → Properties</li>
          <li class="li"><span class="tagAction">Enhancements</span> → Disable all enhancements</li>
          <li class="li"><span class="tagAction">Advanced</span> → 48kHz, Exclusive Mode OFF</li>
          <li class="li"><span class="tagAction">Communications</span> → Do nothing</li>
        </ul>
      </div>

      <div class="card">
        <h3 data-lang="ro" class="show">7) CS2 Settings</h3>
        <h3 data-lang="en">7) CS2 Settings</h3>

        <ul class="list">
          <li class="li"><span class="tagAction">Output Device</span> → alege căștile (nu Default)</li>
          <li class="li"><span class="tagAction">EQ profile</span> → Crisp</li>
          <li class="li"><span class="tagAction">L/R Isolation</span> → 0%</li>
          <li class="li"><span class="tagAction">Perspective Correction</span> → OFF</li>
          <li class="li"><span class="tagAction">Restart</span> joc</li>
        </ul>
      </div>
    </section>

    <!-- VIDEO -->
    <section class="video" aria-label="YouTube test">
      <iframe src="https://www.youtube.com/embed/UHwiME-LhSE?rel=0"
              title="CS2 Audio Fix — Test APO ON/OFF"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen></iframe>
    </section>

<footer class="footerZ">
  <div>by Zevzec</div>
  <img src="./logo.png" alt="Zevzec logo">
</footer>
  </div>

  <script>
    // ---------- Language toggle ----------
    const btnRO = document.getElementById('btnRO');
    const btnEN = document.getElementById('btnEN');

    const allLangBlocks = Array.from(document.querySelectorAll('[data-lang]'));

    function setLang(lang){
      if(lang === 'ro'){
        btnRO.classList.add('active');
        btnEN.classList.remove('active');
        document.documentElement.lang = 'ro';
      } else {
        btnEN.classList.add('active');
        btnRO.classList.remove('active');
        document.documentElement.lang = 'en';
      }
      allLangBlocks.forEach(el => {
        const isMatch = el.getAttribute('data-lang') === lang;
        el.classList.toggle('show', isMatch);
      });
    }

    btnRO.addEventListener('click', () => setLang('ro'));
    btnEN.addEventListener('click', () => setLang('en'));

    // Ensure initial language render
    setLang('ro');    // ---------- A/B Audio Test (Web Audio, OGG, no glitch) ----------
    const FILE_ORIG = './cs2_original.ogg';
    const FILE_COMP = './cs2_compressed.ogg';

    const btnPreload = document.getElementById('btnPreload');
    const btnPlay = document.getElementById('btnPlay');
    const btnStop = document.getElementById('btnStop');

    const mix = document.getElementById('abMix');
    const statusEl = document.getElementById('status');
    const progressFill = document.getElementById('progressFill');
    const led = document.getElementById('led');
    const modeLabel = document.getElementById('modeLabel');

    let ctx = null;
    let bufOrig = null;
    let bufComp = null;

    let srcOrig = null;
    let srcComp = null;

    let gainOrig = null;
    let gainComp = null;

    let isPlaying = false;
    let startTime = 0;
    let pausedAt = 0;

    function clamp01(x){ return Math.min(1, Math.max(0, x)); }

    function setStatus(msg, isError=false){
      statusEl.textContent = msg;
      statusEl.classList.toggle('error', !!isError);
    }

    function setProgress(p){
      const pct = Math.round(clamp01(p) * 100);
      progressFill.style.width = pct + '%';
    }

    function updateLED(){
      const v = clamp01(parseFloat(mix.value || "0"));
      const compressedOn = v >= 0.5;
      led.classList.toggle('on', compressedOn);
      modeLabel.textContent = compressedOn ? 'Compressed' : 'Original';
    }

    function setMix(){
      const v = clamp01(parseFloat(mix.value || "0"));
      if(gainOrig && gainComp){
        gainOrig.gain.value = 1 - v;
        gainComp.gain.value = v;
      }
      updateLED();
    }
    mix.addEventListener('input', setMix);

    async function ensureCtx(){
      if(!ctx){
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        gainOrig = ctx.createGain();
        gainComp = ctx.createGain();
        gainOrig.connect(ctx.destination);
        gainComp.connect(ctx.destination);
      }
      if(ctx.state !== "running") await ctx.resume();
    }

    async function fetchArrayBuffer(url, onProgress){
      const res = await fetch(url, { cache: 'no-cache' });
      if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);

      const contentLength = res.headers.get('content-length');
      const total = contentLength ? parseInt(contentLength, 10) : null;

      if(!res.body){
        const ab = await res.arrayBuffer();
        onProgress(1, 1);
        return ab;
      }

      const reader = res.body.getReader();
      const chunks = [];
      let received = 0;

      while(true){
        const { done, value } = await reader.read();
        if(done) break;
        chunks.push(value);
        received += value.length;
        if(total) onProgress(received, total);
      }

      onProgress(1, 1);

      let size = 0;
      for(const c of chunks) size += c.length;

      const out = new Uint8Array(size);
      let off = 0;
      for(const c of chunks){
        out.set(c, off);
        off += c.length;
      }
      return out.buffer;
    }

    function stopSources(){
      try { if(srcOrig) srcOrig.stop(); } catch(e){}
      try { if(srcComp) srcComp.stop(); } catch(e){}
      srcOrig = null;
      srcComp = null;
    }

    function resetState(){
      stopSources();
      isPlaying = false;
      pausedAt = 0;
      btnPlay.textContent = 'Play';
      mix.value = "0";
      setMix();
    }

    async function preloadAll(){
      try{
        setStatus('Starting preload…');
        setProgress(0);
        resetState();

        await ensureCtx();

        setStatus('Downloading ORIGINAL…');
        const ab1 = await fetchArrayBuffer(FILE_ORIG, (rec, total) => {
          if(total) setProgress((rec/total) * 0.5);
        });

        setStatus('Decoding ORIGINAL…');
        bufOrig = await ctx.decodeAudioData(ab1.slice(0));

        setStatus('Downloading COMPRESSED…');
        const ab2 = await fetchArrayBuffer(FILE_COMP, (rec, total) => {
          if(total) setProgress(0.5 + (rec/total) * 0.5);
        });

        setStatus('Decoding COMPRESSED…');
        bufComp = await ctx.decodeAudioData(ab2.slice(0));

        setProgress(1);
        setStatus('Preloaded. Press Play.');
      } catch(err){
        console.error(err);
        setProgress(0);
        setStatus(`Preload failed: ${err.message}`, true);
      }
    }

    function startBoth(offsetSec){
      stopSources();

      srcOrig = ctx.createBufferSource();
      srcComp = ctx.createBufferSource();
      srcOrig.buffer = bufOrig;
      srcComp.buffer = bufComp;

      srcOrig.connect(gainOrig);
      srcComp.connect(gainComp);

      startTime = ctx.currentTime - offsetSec;
      const when = ctx.currentTime + 0.02;

      const dur = Math.min(bufOrig.duration, bufComp.duration);
      const safeOffset = Math.min(Math.max(0, offsetSec), Math.max(0, dur - 0.05));

      srcOrig.start(when, safeOffset);
      srcComp.start(when, safeOffset);

      srcOrig.stop(when + (dur - safeOffset));
      srcComp.stop(when + (dur - safeOffset));

      srcOrig.onended = () => {
        if(isPlaying){
          isPlaying = false;
          btnPlay.textContent = 'Play';
          setStatus('Finished.');
          pausedAt = 0;
        }
      };
    }

    async function playPause(){
      try{
        await ensureCtx();

        if(!bufOrig || !bufComp){
          setStatus('Press Preload first.');
          return;
        }

        if(!isPlaying){
          startBoth(pausedAt);
          setMix();
          isPlaying = true;
          btnPlay.textContent = 'Pause';
          setStatus('Playing. Move the slider to A/B.');
        } else {
          const nowPos = ctx.currentTime - startTime;
          pausedAt = Math.max(0, nowPos);
          stopSources();
          isPlaying = false;
          btnPlay.textContent = 'Play';
          setStatus('Paused.');
        }
      } catch(err){
        console.error(err);
        setStatus(`Play failed: ${err.message}`, true);
      }
    }

    function stopAll(){
      stopSources();
      isPlaying = false;
      pausedAt = 0;
      btnPlay.textContent = 'Play';
      setStatus('Stopped.');
    }

    // init
    setMix();
    updateLED();
    setStatus('Ready.');

    btnPreload.addEventListener('click', preloadAll);
    btnPlay.addEventListener('click', playPause);
    btnStop.addEventListener('click', stopAll);

  </script>
</body>
</html>
